identifier: "com.github.xishie.download.Bitwarden"
description: "Downloads latest Bitwarden Desktop DMG."
minimum_version: "2.3"

input:
  NAME: "Bitwarden"
  GITHUB_REPO: "bitwarden/clients"

process:
  - processor: "GitHubReleasesInfoProvider"
    arguments:
      github_repo: "%GITHUB_REPO%"
      asset_regex: 'Bitwarden-.*\.dmg'

  - processor: "URLDownloader"
    arguments:
      url: "%release_download_url%"
      filename: "%NAME%.dmg"

  - processor: "Versioner"
    arguments:
      input_plist_path: "/Applications/Bitwarden.app/Contents/Info.plist"
      plist_version_key: "CFBundleShortVersionString"

  - processor: "CodeSignatureVerifier"
    arguments:
      input_path: "%RECIPE_CACHE_DIR%/downloads/%NAME%.app"
      requirement: >
        anchor apple generic and identifier "com.bitwarden.desktop"
        and (
          certificate leaf[field.1.2.840.113635.100.6.1.9] /* exists */
          or 
          (certificate 1[field.1.2.840.113635.100.6.2.6] /* exists */ 
          and certificate leaf[field.1.2.840.113635.100.6.1.13] /* exists */ 
          and certificate leaf[subject.OU] = "LTZ2DNF8XL")
        )

  - processor: "EndOfCheckPhase"